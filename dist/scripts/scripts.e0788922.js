"use strict";angular.module("appGeoApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","rzModule","moment-picker","GoogleMapsNative"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"loginController",controllerAs:"main"}).when("/geo",{templateUrl:"views/about.html"}).when("/ges",{templateUrl:"views/gestion_masiva.html"}).otherwise({redirectTo:"/"})}]).config(["momentPickerProvider",function(a){a.options({minView:"month",maxView:"year",startView:"month",autoclose:!0,yearsFormat:"YYYY",monthsFormat:"MM",daysFormat:"DD",locale:"es",keyboard:!1})}]).run(["$rootScope","$location","$window","$http",function(a,b,c,d){a.credentials=c.sessionStorage.getItem("credentials")||{},a.$on("$locationChangeStart",function(c,d,e){"/"===b.path()||a.credentials.currentUser||(b.path("/"),alert("Indique Usuario y Contraseña para poder entrar"))})}]);var app=angular.module("appGeoApp");app.controller("loginController",["$scope","$rootScope","$location","AuthenticationService",function(a,b,c,d){a.hideLoginLoader=!0,a.login=function(){a.hideLoginLoader=!1,d.ClearCredentials(),d.Login(a.username,a.password,function(e){var f=e.data;b.serError=!1,a.loginForm.$setValidity("user",!0),0==f.estado?(d.SetCredentials(a.username,f.nombreSupervisor,f.codigoSupervisor,f.tipoUsuario),console.dir(b.credentials.currentUser),console.log(b),c.path("/geo")):-1==f.estado&&(a.loginForm.$setValidity("user",!1),a.username="",a.password="",a.hideLoginLoader=!0)})}}]);var app=angular.module("appGeoApp");app.controller("AboutCtrl",["$scope","$rootScope","$location","$timeout","MarkersService","$interval",function(a,b,c,d,e,f){function g(){for(var a="0123456789ABCDEF",b="#",c=0;6>c;c++)b+=a[Math.floor(16*Math.random())];return b}function h(a){var b=1;return"-"===a[0]&&(b=-1,a=a.substr(1)),function(c,d){var e=c[a]<d[a]?-1:c[a]>d[a]?1:0;return e*b}}function i(a,b){moment.locale("es");for(var c=[],d=moment(a),b=moment(b);b>=d;)c.push(moment(d).format("ddd").toUpperCase().replace("SÁB","SAB").replace(".","").replace("MIÉ","MIE")),d=moment(d).add(1,"days");return c}function j(a,c,d,f,g){var a=moment(a).format("YYYY-MM-DD"),c=moment(c).format("YYYY-MM-DD");e.getMarkers(b.selectedVendors,a,c,d,f,function(a){var c=a.data.data;for(var d in c){var e=c[d];for(var f in e){for(var h=0;h<e[f].length;h++){var i=e[f][h],j=i.vendedor_id;0==i.longitud&&0==i.latitud||null==i.longitud||null==i.latitud?(I(i,f,g,j),b.markersQuerys=b.markersQuerys+1):(H(i,f,g,j,null),b.markersQuerys=b.markersQuerys+1)}"geo"==g&&J(j,f)}}}),b.$broadcast("finishedCustomMarkersEvent")}function k(a,c,d){b.routeErrors=0,b.countingMarkers=0,b.markersQuerys=0,b.markersByAddress=0,b.errorMarkers=0,b.zeroResults=0,b.overQueryLimit=0,b.doneQuerys=0,b.markersList=[];var f=i(a,c),g=f.filter(function(a,b,c){return b==c.indexOf(a)});b.planQuerys=b.selectedVendors.length*g.length;for(var h=0;h<b.selectedVendors.length;h++)for(var j=b.selectedVendors[h],k=0;k<g.length;k++){var l=g[k];null==j.codigo&&(j.codigo=j.code),console.log("vendor.codigo",j.codigo),console.log("day",l),e.getPlanification(j.codigo,l,function(a){console.log("response",a),null!=a.data.zona?b.markersList=b.markersList.concat(a.data):console.log("getplanif error"),b.doneQuerys=b.doneQuerys+1})}var m=setInterval(function(){if(b.doneQuerys===b.planQuerys){for(var a=0;a<b.selectedVendors.length;a++)for(var c=b.selectedVendors[a],e=0;e<f.length;e++)for(var g=f[e],h="plan",i=0;i<b.markersList.length;i++){var j=b.markersList[i];if(j.codigoVendedor==c.codigo){for(var k=[],l=0;l<j.zona.length;l++)j.zona[l].dia==g&&(k=k.concat(j.zona[l].cliente));for(var n=0;n<k.length;n++){var o=k[n];null!=o&&(0==o.longitud&&0==o.latitud||null==o.longitud||null==o.latitud?(I(o,h,d,c.codigo),b.markersQuerys=b.markersQuerys+1):(H(o,h,d,c.codigo,null),b.markersQuerys=b.markersQuerys+1))}}}clearInterval(m)}},1e3);b.$broadcast("finishedForeignMarkersEvent")}Number.prototype.formatMoney=function(a,b,c){var d=this,a=isNaN(a=Math.abs(a))?2:a,b=void 0==b?",":b,c=void 0==c?".":c,e=0>d?"-":"",f=String(parseInt(d=Math.abs(Number(d)||0).toFixed(a))),g=(g=f.length)>3?g%3:0;return e+(g?f.substr(0,g)+c:"")+f.substr(g).replace(/(\d{3})(?=\d)/g,"$1"+c)+(a?b+Math.abs(d-f).toFixed(a).slice(2):"")};var l={zoom:9,center:new google.maps.LatLng(-33.455,-70.655),mapTypeId:google.maps.MapTypeId.TERRAIN};a.listRouteGPS=[],a.listBorderRouteGPS=[],a.map=new google.maps.Map(document.getElementById("map"),l),map.addEventListener("google-map-ready",function(a){alert("Map loaded!")}),a.oms=new OverlappingMarkerSpiderfier(a.map,{keepSpiderfied:!0,nearbyDistance:50});var m,n=new google.maps.Polyline({strokeColor:"black",strokeOpacity:1,strokeWeight:7}),o=new google.maps.Polyline({strokeColor:"#FFFF00",strokeOpacity:1,strokeWeight:5}),p=new google.maps.LatLngBounds,q=[],r=[];b.total=0,b.avg=0;var s=(new google.maps.DirectionsService,new google.maps.Geocoder),t={responsive:!0,legend:{display:!1},tooltips:{enabled:!1},hover:{mode:null}};b.finishedCustomMarkers=!1,b.finishedForeignMarkers=!1;var u;a.$on("$routeChangeSuccess",function(){u=null!==document.getElementById("pieChart")?new Chart(document.getElementById("pieChart").getContext("2d"),{type:"pie",data:{labels:["Ventas","No Ventas","Visitas Pendientes","Fuera de Ruta"],datasets:[{backgroundColor:["#0B9B00","#FF1E00","#B0B0B0","#000000"],data:[1,1,1,1]}]},options:t}):null});var v=function(a){var c={nombre:a.nombreVendedor,codigo:a.codigoVendedor};b.vendorsList.push(c)},w=function(a){var c={nombre:a.nombreVendedor,codigo:a.codigoVendedor};b.selectedVendors.push(c)};a.$on("$routeChangeSuccess",function(){var d;"/geo"==c.path()?d="geo":"/ges"==c.path()&&(d="ges"),"ADMI"==b.credentials.currentUser.role?(b.supervisorsList=[],e.getSupervisors(1,d)):"SUPE"==b.credentials.currentUser.role?e.getVendors(b.credentials.currentUser.code,function(c){b.vendorsList=[],a.vendors=c.data;for(var d=0;d<a.vendors.length;d++)v(a.vendors[d])}):b.selectedVendors.push(b.credentials.currentUser)}),b.allSelected=!1,b.buscarAsociado=!0;var x=!1;a.getVendorsBySupervisor=function(c,d){if(b.allSelected=!1,"All"==c&&"geo"==d){b.vendorsList=[],b.selectedVendors=[];for(var f=0;f<b.supervisorsList.length;f++){var g=b.supervisorsList[f].codigo;e.getVendors(g,function(c){a.vendors=c.data;for(var d=0;d<a.vendors.length;d++)w(a.vendors[d]),b.allSelected=!0})}}else if("All"==c&&"ges"==d){x=!0,b.selectedVendors=[];for(var f=0;f<b.supervisorsList.length;f++){var g=b.supervisorsList[f].codigo;e.getVendors(g,function(b){a.vendors=b.data;for(var c=0;c<a.vendors.length;c++)w(a.vendors[c])})}}else"All"!=c&&"ges"==d?(x=!1,e.getVendors(c,function(c){b.selectedVendors=[],a.vendors=c.data;for(var d=0;d<a.vendors.length;d++)w(a.vendors[d])})):e.getVendors(c,function(c){b.vendorsList=[],b.selectedVendors=[],a.vendors=c.data;for(var d=0;d<a.vendors.length;d++)v(a.vendors[d])})},a.slider={minValue:"00:00",maxValue:"23:59",options:{stepsArray:["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","23:59"]}},a.ctrl={},a.today=moment().format("DD-MM-YYYY"),console.log("today",a.today),a.types=["Planificación","Venta","No Venta","Venta Fuera de Ruta","GPS"];var y=new google.maps.Size(30,45),z=new google.maps.Point(0,0),A=new google.maps.Point(15,45),B=new google.maps.Point(15,15),C=new google.maps.Size(45,45),D=new google.maps.Point(0,0),E=new google.maps.Point(22.5,45),F=new google.maps.Point(22.5,15);a.icons={planPin:{url:"images/pin-rutafutura.b6b345c4.png",scaledSize:y,origin:z,anchor:A,labelOrigin:B},ventaPin:{url:"images/pin-venta.4ed6b99c.png",scaledSize:y,origin:z,anchor:A,labelOrigin:B},naranjoPin:{url:"images/pin-naranjo.1090203b.png",scaledSize:y,origin:z,anchor:A,labelOrigin:B},amarilloPin:{url:"images/pin-amarillo.ff53f53a.png",scaledSize:y,origin:z,anchor:A,labelOrigin:B},noVentaPin:{url:"images/pin-noventa.0dab3f3c.png",scaledSize:y,origin:z,anchor:A,labelOrigin:B},fueraDeRutaPin:{url:"images/pin-venta-fueraderuta.f4a22f4c.png",scaledSize:y,origin:z,anchor:A,labelOrigin:B},gpsPin:{url:"images/pin-gps.317c9af7.png",scaledSize:y,origin:z,anchor:A,labelOrigin:B},planSq:{url:"images/rutafutura.4d5dfb17.png",scaledSize:C,origin:D,anchor:E,labelOrigin:F},ventaSq:{url:"images/venta.dbcf331a.png",scaledSize:C,origin:D,anchor:E,labelOrigin:F},noVentaSq:{url:"images/no venta.d27d477d.png",scaledSize:C,origin:D,anchor:E,labelOrigin:F},fueraDeRutaSq:{url:"images/fueraderuta.1b8b094f.png",scaledSize:C,origin:D,anchor:E,labelOrigin:F},gpsSq:{url:"images/gps.2f001fa5.png",scaledSize:C,origin:D,anchor:E,labelOrigin:F}},b.markers=[];var G=new google.maps.InfoWindow;a.oms.addListener("unspiderfy",function(){G.close()}),google.maps.event.addListener(G,"closeclick",function(){a.oms.unspiderfy()}),a.openInfoWindow=function(a,b){a.preventDefault(),google.maps.event.trigger(b,"click")};var H=function(c,d,e,f,g){var h;"geo"==e?h=a.map:"ges"==e&&(h=null);for(var i,j=0;j<b.selectedVendors.length;j++)b.selectedVendors[j].codigo==f&&(i=b.selectedVendors[j].nombre);if("plan"==d)var k=a.icons.planSq,l=c.razonSocial,m=c.rutCliente,r=c.razonSocial,s="Planificación",t=null,u='<div class="infoWindowContent"><ul><li>RUT: '+c.rutCliente+"</li></ul></div>";else if(null==c.pedido_id)var k=a.icons.gpsSq,l="GPS",s="GPS",t=null,m=null,r=null,u='<div class="infoWindowContent"><ul><li>Fecha: '+moment(c.fecha).format("DD/MM/YYYY")+"</li><li>Hora: "+moment(c.fecha).format("HH:mm")+"</li></ul></div>";else{var l=c.pedido.cliente.nombre,r=c.pedido.cliente.nombre,m=c.pedido.cliente_rut,t=c.pedido.total,v=c.pedido.total.formatMoney(0,".",","),u='<div class="infoWindowContent"><ul><li>RUT: '+c.pedido.cliente_rut+"</li><li>Total Pedido: $"+v+"</li><li>Fecha: "+moment(c.fecha).format("DD/MM/YYYY")+"</li><li>Hora: "+moment(c.fecha).format("HH:mm")+"</li></ul></div>";if(null!=c.pedido.razon_id&&0!=c.pedido.razon_id)var k=a.icons.noVentaSq,s="No Venta";else if(null!=c.pedido.fuera_de_ruta&&0!=c.pedido.fuera_de_ruta)var k=a.icons.fueraDeRutaSq,s="Venta Fuera de Ruta";else var k=a.icons.ventaSq,s="Venta"}var w=f.toString();void 0!==c.pedido&&void 0!==c.pedido.markerText&&(w=c.pedido.markerText);var x=new google.maps.LatLng(c.latitud,c.longitud);null!=g&&(x=g);var y=new google.maps.Marker({map:h,position:x,title:l,clientName:r,client:m,label:w,vendor:f,vendorName:i,day:c.fecha,hour:moment(c.fecha).format("HH:mm"),money:t,icon:k,type:s,day:d,lat:c.latitud,lng:c.longitud,page:e,visible:!1,geoCodeAddress:g,content:u});google.maps.event.addListener(y,"spider_click",function(){if(console.log(b.markers),G.close(),G.setContent('<h2 class="infoWindowTitle">'+y.title+"</h2>"+y.content),G.open(a.map,y),("Planificación"==y.type||"Venta"==y.type)&&(p=new google.maps.LatLngBounds,b.buscarAsociado))for(var c=0;c<b.markers.length;c++){var d=b.markers[c];if(d.client==y.client&&d.type!=y.type&&null!=y.map){q=[],n.setPath(q),o.setPath(q);var e=new google.maps.LatLng(y.lat,y.lng),f=new google.maps.LatLng(d.lat,d.lng);a.oms.unspiderfy(),G.open(a.map,y),p.extend(e),p.extend(f),q.push(e),q.push(f),n.setPath(q),o.setPath(q),n.setMap(a.map),o.setMap(a.map),b.buscarAsociado=!1,a.map.fitBounds(p)}}b.buscarAsociado=!0});for(var j=0;j<a.selectedTypes.length;j++)y.type==a.selectedTypes[j]&&"ges"!=y.page&&(y.visible=!0);var z=!1;b.markers.forEach(function(a){return a.client===y.client&&(null!=g&&a.geoCodeAddress===y.geoCodeAddress||a.lat===y.lat&&a.lng===y.lng)?(z=!0,!1):void 0}),1==z&&(y.visible=!1),b.markers.push(y),b.countingMarkers=b.countingMarkers+1,a.oms.addMarker(y)},I=function(a,c,d,e){b.markersByAddress=b.markersByAddress+1,s.geocode({address:a.direccion+a.numeroDireccion+","+a.descripcionComuna+","+a.descripcionCiudad+",Chile"},function(f,g){g==google.maps.GeocoderStatus.OK?H(a,c,d,e,f[0].geometry.location):("ZERO_RESULTS"==g?b.zeroResults=b.zeroResults+1:"OVER_QUERY_LIMIT"==g&&(b.overQueryLimit=b.overQueryLimit+1),b.countingMarkers=b.countingMarkers+1,b.errorMarkers=b.errorMarkers+1)})};b.directionsArray=[];var J=function(c,d){moment.locale("es");var e,f=moment(d).format("ddd").toUpperCase().replace(".","");"LUN"==f?e="red":"MAR"==f?e="blue":"MIÉ"==f?e="green":"JUE"==f?e="purple":"VIE"==f?e="orange":"SÁB"==f?e="brown":"DOM"==f&&(e="black");for(var h=[],i=0;i<b.markers.length;i++){var j=b.markers[i];j.vendor==c&&j.day==d&&null!=j.map&&"GPS"==j.type&&h.push(j.getPosition())}var k=(h[0],h[h.length-1]),l=[];for(a.listRouteGPS=[],a.listBorderRouteGPS=[],m=g();r.includes(m)||m==e;)m=g();r.push(m),console.log("vendorColor:",m);for(var i=1;i<h.length-1;i++)h[i]!=k&&(l=[],a.routeGPS=new google.maps.Polyline({strokeOpacity:1,strokeColor:e,strokeWeight:4}),a.borderRouteGPS=new google.maps.Polyline({strokeColor:m,strokeOpacity:1,strokeWeight:8}),a.borderRouteGPS.setMap(a.map),a.routeGPS.setMap(a.map),l.push(h[i]),l.push(h[i+1]),a.borderRouteGPS.setPath(l),a.routeGPS.setPath(l),a.listBorderRouteGPS.push(a.borderRouteGPS),a.listRouteGPS.push(a.routeGPS))};b.selectedVendors=[],a.selectVendor=function(a,c){if(1==c)b.selectedVendors.push(a);else if(0==c)for(var d=0;d<b.selectedVendors.length;d++)b.selectedVendors[d]==a&&(b.selectedVendors.splice(d,1),d--)},a.selectedTypes=["Planificación","Venta","No Venta","Venta Fuera de Ruta","GPS"],a.selectType=function(b,c){if(1==c)a.selectedTypes.push(b);else if(0==c)for(var d=0;d<a.selectedTypes.length;d++)a.selectedTypes[d]==b&&(a.selectedTypes.splice(d,1),d--)};var K=function(){b.total=0;for(var a=0;a<b.markers.length;a++)b.total=b.total+b.markers[a].money;b.avg=b.total/(b.ventas+b.ventasNo)},L=function(){b.ventas=0,b.noVentas=0,b.ventasNo=0,b.gps=0,b.planificacion=0,b.visitasPlanificadas=0;for(var a=0;a<b.markers.length;a++){var c=b.markers[a];"Venta"==c.type?(b.ventas=b.ventas+1,b.planificacion=b.planificacion-1):"No Venta"==c.type?(b.noVentas=b.noVentas+1,b.planificacion=b.planificacion-1):"Venta Fuera de Ruta"==c.type?b.ventasNo=b.ventasNo+1:"GPS"==c.type?b.gps=b.gps+1:"Planificación"==c.type&&(b.planificacion=b.planificacion+1,b.visitasPlanificadas=b.visitasPlanificadas+1)}b.planificacion<0&&(b.planificacion=0)};b.reporteria=[],a.sortProperty="ventas",a.sortReverse=!0,a.sortBy=function(b){a.sortReverse=a.sortProperty===b?!a.sortReverse:!1,a.sortProperty=b};var M=function(a){for(var c=[],d=0;d<b.markers.length;d++)b.markers[d].vendor==a.codigo&&c.push(b.markers[d]);return c},N=function(a,c,d,e,f,g,h,i){var j={nombre:a,codigo:c,ventas:d,plan:e,noVentas:f,perf:h,money:g,moneyString:g.formatMoney(0,".",","),avg:i,avgString:i.formatMoney(0,".",",")};b.reporteria.push(j),b.readyReports=b.readyReports+1},O=function(a){b.reporteria=[],b.expectedReports=0,b.readyReports=0;for(var c=0;c<b.selectedVendors.length;c++){b.expectedReports=b.expectedReports+1;for(var d=M(b.selectedVendors[c]),e=0,f=0,g=0,i=0,j=0;j<d.length;j++)i+=d[j].money,"Venta"==d[j].type?(e+=1,g-=1):"Planificación"==d[j].type?g+=1:"Venta Fuera de Ruta"==d[j].type?e+=1:"No Venta"==d[j].type&&(f+=1,g-=1);var k=e/(g+e+f)*100||0,l=i/e||0;N(b.selectedVendors[c].nombre,b.selectedVendors[c].codigo,e,g,f,i,k,l)}var m=setInterval(function(){if(b.readyReports===b.expectedReports){if(b.reporteria.sort(h("ventas")).reverse(),"ges"==a)for(var c=0;c<b.selectedVendors.length;c++){for(var d=b.selectedVendors[c],e=b.reporteria.map(function(a){return a.nombre}).indexOf(d.nombre),f=M(d),g=[],i=0;i<f.length;i++)"Planificación"!=f[i].type&&g.push(f[i]);var j=g[g.length-1];if(void 0!=j)for(var i=0;i<b.reporteria.length;i++){var k=b.reporteria[i];k.codigo==d.codigo&&P(j,k.ventas,k.noVentas,k.plan,k.money,k.avg,k.perf,e)}}clearInterval(m)}},1e3)},P=function(c,d,e,f,g,h,i,j){0>f&&(f=0);var k,j=Number(j)+1;25>=i?k=a.icons.noVentaPin:50>=i&&i>25?k=a.icons.naranjoPin:i>50&&75>=i?k=a.icons.amarilloPin:i>75&&(k=a.icons.ventaPin);var l=new google.maps.Marker({map:a.map,position:new google.maps.LatLng(c.lat,c.lng),title:c.vendorName,ventas:d||0,noVentas:e||0,plan:f||0,money:g||0,moneyString:g.formatMoney(0,".",","),avg:h||0,avgString:h.formatMoney(0,".",","),perf:i||0,icon:k,ranking:"#"+j}),m='<div class="infoWindowContent"><ul><li>Ranking: #'+j+"</li><li>Ventas: "+d+"</li><li>No Ventas: "+e+"</li><li>Visitas Pendientes: "+f+"</li><li>Total Venta: $"+g.formatMoney(0,".",",")+"</li><li>Ticket Promedio: $"+h.formatMoney(0,".",",")+"</li></ul></div>";google.maps.event.addListener(l,"click",function(){G.setContent('<h2 class="infoWindowTitle">'+l.title+"</h2>"+m),G.open(a.map,l)}),b.markers.push(l)};a.days=["LUN","MAR","MIE","JUE","VIE","SAB","DOM"],b.loadGraph=function(a){var c=[];L(),K(),O(a),null!=u&&u.destroy(),c=0==b.ventas&&0==b.noVentas&&0==b.planificacion&&0==b.ventasNo?[1,1,1,1]:[b.ventas,b.noVentas,b.planificacion,b.ventasNo],u=new Chart(document.getElementById("pieChart").getContext("2d"),{type:"pie",data:{datasets:[{backgroundColor:["#0B9B00","#FF1E00","#B0B0B0","#000000"],labels:["Ventas","No Ventas","Visitas Pendientes","Fuera de Ruta"],data:c}]},options:t})},a.hideLoader=!0,a.geoMarkers=function(c,d,e,f){if(void 0!=typeof b.selectedVendors&&b.selectedVendors.length<1)return alert("Debe seleccionar al menos un vendedor"),!1;a.hideLoader=!1,r=[];for(var g=0;g<a.listRouteGPS.length;g++)a.listRouteGPS[g].setMap(null),a.listRouteGPS.splice(g,1),g--;a.listRouteGPS=[];for(var g=0;g<a.listBorderRouteGPS.length;g++)a.listBorderRouteGPS[g].setMap(null),a.listBorderRouteGPS.splice(g,1),g--;a.listBorderRouteGPS=[];for(var g=0;g<b.directionsArray.length;g++)b.directionsArray[g].setMap(null),b.directionsArray.splice(g,1),g--;for(var g=0;g<b.markers.length;g++)b.markers[g].setMap(null),b.markers.splice(g,1),g--;var h="geo";k(c,d,h),j(c,d,e,f,h);var i=setInterval(function(){if(b.finishedCustomMarkers&&b.finishedForeignMarkers&&b.doneQuerys===b.planQuerys&&b.countingMarkers===b.markersQuerys){b.loadGraph(h),a.hideLoader=!0;var c=angular.element(document.getElementById("Geo"));c.scope().$apply(),clearInterval(i)}},1e3)},b.$on("finishedCustomMarkersEvent",function(){b.finishedCustomMarkers=!0}),b.$on("finishedForeignMarkersEvent",function(){b.finishedForeignMarkers=!0}),a.hideLoader=!0,b.gesMarkers=function(c,d,e){a.hideLoader=!1,a.saving=!0,"SUPE"==b.credentials.currentUser.role&&a.getVendorsBySupervisor(b.credentials.currentUser.code,"ges");for(var g=0;g<b.directionsArray.length;g++)b.directionsArray[g].setMap(null),b.directionsArray.splice(g,1),g--;for(var g=0;g<b.markers.length;g++)b.markers[g].setMap(null),b.markers.splice(g,1),g--;var h="ges";k(c,c,h),j(c,c,d,e,h);var i=x?15e3:1e4,l=f(function(){b.finishedCustomMarkers&&b.finishedForeignMarkers&&b.doneQuerys===b.planQuerys&&b.countingMarkers===b.markersQuerys&&(O(h),a.hideLoader=!0,a.saving=!1,clearInterval(l))},i,!1)}}]),angular.module("appGeoApp").factory("AuthenticationService",["$http","$rootScope","$window",function(a,b,c){var d={};return d.Login=function(c,d,e){a.post("http://200.68.49.237:8080/ServiciosCaseritaWEB/servicioRest/usuarioMonitoreo/post",{usuario:c,password:d}).then(function(a){e(a)},function(a){b.serError=!0})},d.SetCredentials=function(a,d,e,f){b.credentials={currentUser:{username:a,name:d,code:e,role:f}},c.sessionStorage.setItem("credentials",b.credentials),console.log(b)},d.ClearCredentials=function(){b.credentials={},c.sessionStorage.removeItem("credentials")},d}]),angular.module("appGeoApp").constant("config",{ipColorServer:"http://200.68.49.232:81/",ipPlanServer:"http://200.68.49.237:8080/"}),angular.module("appGeoApp").factory("MarkersService",["$http","$rootScope","$location","config",function(a,b,c,d){var e={};e.getMarkers=function(b,c,e,f,g,h){for(var i=new FormData,j=0;j<b.length;j++)i.append("vendedor_ids[]",b[j].codigo);i.append("from_day",c),i.append("to_day",e),i.append("from_hour",f),i.append("to_hour",g),a({method:"POST",url:d.ipColorServer+"geolocation/map",transformRequest:angular.identity,headers:{"Content-Type":void 0},data:i}).then(function(a){h(a)},function(a){})},e.getVendors=function(b,c){a.post(d.ipPlanServer+"ServiciosCaseritaWEB/servicioRest/vendedor/post",{codigoSupervisor:b}).then(function(a){c(a)},function(a){})},e.getNumbers=function(b,c,e,f,g,h){for(var i=new FormData,j=0;j<b.length;j++)i.append("vendedor_ids[]",b[j]);i.append("from_day",c),i.append("to_day",e),i.append("from_hour",f),i.append("to_hour",g),a({method:"POST",url:d.ipColorServer+"geolocation/graph-data",transformRequest:angular.identity,headers:{"Content-Type":void 0},data:i}).then(function(a){h(a)},function(a){})},e.getPlanification=function(b,c,e){a.post(d.ipPlanServer+"ServiciosCaseritaWEB/servicioRest/clienteVendedor/post",{vendedor:b,dia:c}).then(function(a){console.log("planificacion",a),e(a)},function(a){})},b.supervisorsList=[];var f=function(a){var c={nombre:a.nombreSupervisor,codigo:a.codigoSupervisor};b.supervisorsList.push(c)},g={nombreSupervisor:"TODOS LOS SUPERVISORES",codigoSupervisor:"All"};return b.contador=0,e.getSupervisors=function(h,i,j){b.todosAgregado&&(b.contador=0,b.todosAgregado=!1),a.post(d.ipPlanServer+"ServiciosCaseritaWEB/servicioRest/vendedor/post",{codigoSupervisor:h}).then(function(a){var d;"/ges"==c.path()?d="ges":"/geo"==c.path()&&(d="geo"),d==i&&(-2!==a.data.codigoEstado?(f(a.data[0]),e.getSupervisors(h+1,i)):(b.contador++,b.contador>10?(b.todosAgregado=!0,f(g)):e.getSupervisors(h+1,i)))},function(a){})},e}]),angular.module("appGeoApp").controller("CollapseController",["$rootScope","$scope","$timeout",function(a,b,c){b.collapse1=function(){1==a.Open1?(document.getElementById("Collapsible1").style.display="none",a.Open1=!1):(document.getElementById("Collapsible1").style.display="inline-block",a.Open1=!0,c(function(){b.$broadcast("rzSliderForceRender")}))},b.collapse2=function(){1==a.Open2?(document.getElementById("Collapsible2").style.display="none",a.Open2=!1):(document.getElementById("Collapsible2").style.display="inline-block",a.Open2=!0)},b.collapse3=function(){1==a.Open3?(document.getElementById("Collapsible3").style.display="none",a.Open3=!1):(document.getElementById("Collapsible3").style.display="inline-block",a.Open3=!0)},b.mapTab=function(){document.getElementById("map").style.display="inline-block",document.getElementById("rep").style.display="none",document.getElementById("mapTab").style.backgroundColor="white",document.getElementById("repTab").style.backgroundColor="#F8F8F8"},b.repTab=function(){document.getElementById("map").style.display="none",document.getElementById("rep").style.display="inline-block",document.getElementById("mapTab").style.backgroundColor="#F8F8F8",document.getElementById("repTab").style.backgroundColor="white"}}]),angular.module("appGeoApp").controller("LinkCtrl",["$scope","$rootScope","$location","AuthenticationService",function(a,b,c,d){a.linkGeo=function(){c.path("/geo")},a.linkGes=function(){c.path("/ges")},a.linkLogin=function(){c.path("/"),d.ClearCredentials()}}]),angular.module("appGeoApp").controller("GestionMasivaCtrl",["$scope","$rootScope","gestionservice","$filter",function(a,b,c,d){function e(a){var b=1;return"-"===a[0]&&(b=-1,a=a.substr(1)),function(c,d){var e=c[a]<d[a]?-1:c[a]>d[a]?1:0;return e*b}}var f,g=new google.maps.InfoWindow,h=new google.maps.Size(30,45);if(a.marcadores=[],a.ctrl={},a.today=moment().format("DD-MM-YYYY"),a.dia,a.collapsea=!1,a.collapseb=!1,a.hideLoader=!0,a.supervisores=b.supervisorsList,a.slider={minValue:"00:00",maxValue:"23:59",options:{stepsArray:["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","23:59"]}},"SUPE"==b.credentials.currentUser.role){var i=b.credentials.currentUser.code;c.Vendedores(i).then(function(b){a.vendedores=b.data,console.log(b.data)})["catch"](function(a){console.log(a)})}a.getvendedores=function(b){if(a.vendedoresConRank=[],a.vendedoresSinRank=[],a.collapseb=a.collapseb?!a.collapseb:a.collapseb,console.log("codigo",b),"All"==b){a.vendedores=[];for(var d=0;d<a.supervisores.length;d++)if("All"!=a.supervisores[d].codigo){var e=a.supervisores[d].codigo;c.Vendedores(e).then(function(b){for(var c=b.data,d=0;d<c.length;d++)a.vendedores.push(c[d]);console.log(b.data)})["catch"](function(a){console.log(a)})}}else c.Vendedores(b).then(function(b){a.vendedores=b.data})["catch"](function(a){console.log(a)})},a.bindMap=function(b){a.mapa=b},a.getMarcadores=function(b,g,i){if(a.hideLoader=!1,void 0===a.vendedores)return alert("Debe seleccionar supervisor."),a.hideLoader=!0,!1;var j=moment(b).format("YYYY-MM-DD");c.Marcadores(a.vendedores,j,j,g,i).then(function(b){a.marcadores=[],console.log("response Marcadores",b),f=new google.maps.LatLngBounds;for(var c=b.data,g=0;g<c.length;g++)if(0!=c[g].geoloc){var i={},j=new google.maps.LatLng(c[g].geoloc.latitud,c[g].geoloc.longitud);i.position=j;var k=c[g].planificacion;console.log(c[g].planificacion);var l=c[g].vendedor_id,m=c[g].nombre,n=c[g].ventas,o=c[g].no_ventas,p=c[g].total,q=c[g].ticket,r=(n+o)/k*100;i.visitasPlanificadas=k,i.vendedorId=l,i.nombre=m,i.cantidadVentas=n,i.cantidadNoVentas=o,i.montoVentas=p,i.ticketPromedio=q,i.rendimiento=r,25>=r?i.icon={url:"/images/pin-noventa.0dab3f3c.png",scaledSize:h}:r>25&&50>=r?i.icon={url:"/images/pin-naranjo.1090203b.png",scaledSize:h}:r>50&&75>=r?i.icon={url:"/images/pin-amarillo.ff53f53a.png",scaledSize:h}:r>75&&(i.icon={url:"/images/pin-venta.4ed6b99c.png",scaledSize:h}),a.marcadores.push(i),f.extend(i.position)}if(a.marcadores.sort(e("rendimiento")).reverse(),a.vendedoresConRank=[],a.vendedoresSinRank=[],a.marcadores.length>0){for(var g=0;g<a.marcadores.length;g++){var s=a.marcadores[g];s.ranking=g+1,s.infowindow={},s.infowindow.content='<h2 class="infoWindowTitle">'+s.nombre+'</h2><div class="infoWindowContent"><ul><li><span>Ranking</span>: #'+s.ranking+"</li><li><span>Ventas</span>: "+s.cantidadVentas+"</li><li><span>No Ventas</span>: "+s.cantidadNoVentas+"</li><li><span>Visitas Planificadas</span>: "+s.visitasPlanificadas+"</li><li><span>Total Venta</span>: "+d("currency")(s.montoVentas)+"</li><li><span>Ticket Promedio</span>: "+d("currency")(s.ticketPromedio)+"</li></ul></div>";var t={};t.nombre=s.nombre,t.ranking=s.ranking,t.vendedorId=s.vendedorId,a.vendedoresConRank.push(t)}for(var g=0;g<a.vendedores.length;g++){var u=a.vendedoresConRank.some(function(b){return b.vendedorId==a.vendedores[g].codigoVendedor});u||a.vendedoresSinRank.push({nombre:a.vendedores[g].nombreVendedor,vendedorId:a.vendedores[g].codigoVendedor})}if(1==a.marcadores.length){a.marcadores[0].position;a.mapa.setOptions({center:j})}else a.mapa.fitBounds(f)}else{for(var g=0;g<a.vendedores.length;g++){var t={};t.nombre=a.vendedores[g].nombreVendedor,t.vendedorId=a.vendedores[g].codigoVendedor,a.vendedoresSinRank.push(t)}alert("No se encontraron vendedores con información en la fecha indicada."),a.mapa.setOptions({zoom:9,center:new google.maps.LatLng(-33.455,-70.655),mapTypeId:google.maps.MapTypeId.TERRAIN})}a.hideLoader=!0,a.collapseb=a.collapseb?a.collapseb:!a.collapseb})["catch"](function(b){console.log(b),a.hideLoader=!0})},a.showInfoWindow=function(a,b,c){g.setContent(c.infowindow.content),g.open(a,b)},a.mostrar=function(b){1===b&&(a.collapsea=!a.collapsea),2==b&&(a.collapseb=!a.collapseb)}}]),angular.module("appGeoApp").factory("gestionservice",["$http","$q","config",function(a,b,c){function d(d){var e=b.defer(),f=e.promise;return a.post(c.ipPlanServer+"ServiciosCaseritaWEB/servicioRest/vendedor/post",{codigoSupervisor:d}).then(function(a){e.resolve(a)})["catch"](function(a){e.reject(a)}),f}function e(c,d,e,f,g){for(var h=new FormData,i=0;i<c.length;i++)h.append("vendedor_ids[]",c[i].codigoVendedor);h.append("from_day",d),h.append("to_day",e),h.append("from_hour",f),h.append("to_hour",g);var j=b.defer(),k=j.promise;return a({method:"POST",url:"http://200.68.49.232:81/geolocation/markers",transformRequest:angular.identity,headers:{"Content-Type":void 0},data:h}).then(function(a){j.resolve(a)})["catch"](function(a){j.reject(a)}),k}return{Vendedores:d,Marcadores:e}}]),angular.module("appGeoApp").run(["$templateCache",function(a){a.put("views/about.html",'<nav class="header" ng-controller="LinkCtrl"><img class="logo" src="images/logo-caserita.ca8302fa.jpg" alt="logo"> <ul class="left"> <li ng-click="linkGeo()">Georeferenciación</li> <li ng-click="linkGes()" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'">Gestión Masiva de Vendedores</li> </ul> <ul class="right"> <li class="text" ng-model="credentials">Bienvenido {{credentials.currentUser.name}}</li> <li> <button type="button" ng-click="linkLogin()">Cerrar Sesión</button> </li> </ul> </nav> <div class="margin"></div> <div id="Geo" ng-controller="AboutCtrl"> <div class="selectors" ng-controller="CollapseController"> <button class="collapse" type="button" ng-click="collapse1()" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'">Supervisor y rango de fecha</button> <ul class="collapsible" id="Collapsible1"> <li ng-if="credentials.currentUser.role == \'ADMI\'"> <select ng-options="supervisor as supervisor.nombre for supervisor in supervisorsList" ng-model="selectedSupervisor" ng-change="getVendorsBySupervisor(selectedSupervisor.codigo, \'geo\')"> <option value="" disabled selected hidden>Seleccione Supervisor</option> </select> </li> <li> <input class="text" ng-model="ctrl.fromDay" placeholder="Fecha de Inicio" moment-picker="ctrl.fromDay" format="DD-MM-YYYY" max-date="today" ng-model-options="{ updateOn: \'blur\' }"> </li> <li> <input class="text" ng-model="ctrl.toDay" placeholder="Fecha de Fin" moment-picker="ctrl.toDay" format="DD-MM-YYYY" min-date="ctrl.fromDay" max-date="today" ng-model-options="{ updateOn: \'blur\' }"> </li> <li class="sliderContainer"> <rzslider class="custom-slider" rz-slider-model="slider.minValue" rz-slider-high="slider.maxValue" rz-slider-options="slider.options"></rzslider> </li> </ul> <button class="collapse" type="button" ng-click="collapse2()" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'" ng-show="allSelected == false">Seleccionar vendedores</button> <ul class="collapsible" id="Collapsible2" ng-show="allSelected == false"> <div class="vendorsWrap"> <label ng-repeat="vendor in vendorsList"> <input class="check" type="checkbox" ng-model="selectedVendor" ng-change="selectVendor(vendor, selectedVendor)" ng-checked="selectedVendor">{{vendor.nombre | limitTo: 24 }}{{vendor.nombre.length > 24 ? \'...\' : \'\'}} ({{vendor.codigo}}) </label> </div> </ul> <button class="collapse" type="button" ng-click="collapse2()" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'" ng-show="allSelected == true">Todos los vendedores seleccionados</button> <button class="collapse" type="button" ng-click="collapse3()">Filtros</button> <ul class="collapsible" id="Collapsible3"> <div class="filtersWrap"> <label ng-repeat="type in types"> <input class="check" type="checkbox" ng-model="selectedType" ng-change="selectType(type, selectedType)" ng-init="selectedType=true" ng-checked="selectedType">{{type}} </label> </div> </ul> </div> <button class="greenBar" type="button" ng-click="geoMarkers(ctrl.fromDay, ctrl.toDay, slider.minValue, slider.maxValue)">Actualizar Resultados<img ng-hide="hideLoader" src="images/loader.7f9353b0.gif" width="20" height="20"></button> <div class="wrapDatos"> <div class="datosLeft"> <div class="titleWrap"> <h1>Resumen Vendedores</h1> </div> <div class="textWrap" id="DatosPrueba"> <p><img src="images/pin-rutafutura.b6b345c4.png">Planificación: {{visitasPlanificadas}}</p> <p><img src="images/pin-venta.4ed6b99c.png">Ventas: {{ventas}}</p> <p><img src="images/pin-noventa.0dab3f3c.png">No Ventas: {{noVentas}}</p> <p><img src="images/pin-venta-fueraderuta.f4a22f4c.png">Ventas Fuera de Ruta: {{ventasNo}}</p> <p><img src="images/pin-gps.317c9af7.png">GPS: {{gps}}</p> </div> </div> <div class="datosCenter"> <div class="titleWrap"> <h1>Rendimiento</h1> </div> <div class="chartContainer"> <canvas id="pieChart"></canvas> </div> <div class="textContainer"> <p> <div class="greenDatos"></div>Ventas </p> <p> <div class="redDatos"></div>No Ventas </p> <p> <div class="greyDatos"></div>Visitas Pendientes </p> <p> <div class="futureDatos"></div>Fuera de Ruta </p> </div> </div> <div class="datosRight"> <div class="innerDatos"> <h1>Total Venta: ${{total | number}}</h1> </div> <div class="innerDatos"> <h1>Ticket Promedio: ${{avg | number}}</h1> </div> </div> </div> <div class="tabs" ng-controller="CollapseController" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'"> <button class="tab" id="mapTab" type="button" ng-click="mapTab()">Mapa</button> <button class="tab" id="repTab" type="button" ng-click="repTab()">Reporteria</button> </div> <div id="map"></div> <div id="rep" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'"> <table> <tr class="yellow"> <td ng-click="sortBy(\'ranking\')">Ranking <div class="sort" ng-show="sortProperty === \'ranking\'" ng-class="{reverse: sortReverse}"></div> </td> <td ng-click="sortBy(\'codigo\')">Vendedor <div class="sort" ng-show="sortProperty === \'codigo\'" ng-class="{reverse: sortReverse}"></div> </td> <td ng-click="sortBy(\'nombre\')">Código Vendedor <div class="sort" ng-show="sortProperty === \'nombre\'" ng-class="{reverse: sortReverse}"></div> </td> <td ng-click="sortBy(\'ventas\')">Ventas <div class="sort" ng-show="sortProperty === \'ventas\'" ng-class="{reverse: sortReverse}"></div> </td> <td ng-click="sortBy(\'noVentas\')">No Ventas <div class="sort" ng-show="sortProperty === \'noVentas\'" ng-class="{reverse: sortReverse}"></div> </td> <td ng-click="sortBy(\'plan\')">Visitas Pendientes <div class="sort" ng-show="sortProperty === \'plan\'" ng-class="{reverse: sortReverse}"></div> </td> <td ng-click="sortBy(\'perf\')">Rendimiento <div class="sort" ng-show="sortProperty === \'perf\'" ng-class="{reverse: sortReverse}"></div> </td> <td ng-click="sortBy(\'money\')">Total Venta <div class="sort" ng-show="sortProperty === \'money\'" ng-class="{reverse: sortReverse}"></div> </td> <td ng-click="sortBy(\'avg\')">Ticket Promedio <div class="sort" ng-show="sortProperty === \'avg\'" ng-class="{reverse: sortReverse}"></div> </td> </tr> <tr ng-repeat="vendor in reporteria | orderBy:sortProperty:sortReverse"> <td># {{reporteria.indexOf(vendor) +1}}</td> <td>{{vendor.nombre}}</td> <td>{{vendor.codigo}}</td> <td>{{vendor.ventas}}</td> <td>{{vendor.noVentas}}</td> <td>{{vendor.plan}}</td> <td>{{vendor.perf | limitTo: 5}}%</td> <td>${{vendor.moneyString}}</td> <td>${{vendor.avgString}}</td> </tr> </table> </div> </div>'),
a.put("views/gestion_masiva.html",'<nav class="header" ng-controller="LinkCtrl"><img class="logo" src="images/logo-caserita.ca8302fa.jpg" alt="logo"> <ul class="left"> <li ng-click="linkGeo()">Georeferenciación</li> <li ng-click="linkGes()" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'">Gestión Masiva de Vendedores</li> </ul> <ul class="right"> <li class="text" ng-model="credentials">Bienvenido {{credentials.currentUser.name}}</li> <li> <button type="button" ng-click="linkLogin()">Cerrar Sesión</button> </li> </ul> </nav> <div class="margin"></div> <div id="Ges" ng-controller="GestionMasivaCtrl"> <div class="selectors"> <button class="collapse" ng-click="mostrar(1)" type="button" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'">Supervisor y rango de fecha</button> <ul class="collapsible" ng-if="collapsea" id="Collapsible1Ges"> <li ng-if="credentials.currentUser.role == \'ADMI\'"> <select ng-options="supervisor as supervisor.nombre for supervisor in supervisores" ng-model="selectedSupervisor" ng-change="getvendedores(selectedSupervisor.codigo)"> <option value="" disabled selected>Seleccione Supervisor</option> </select> </li> <li> <input class="text" ng-model="ctrl.dia" placeholder="Seleccione día" moment-picker="ctrl.dia" format="DD-MM-YYYY" max-date="today" ng-model-options="{ updateOn: \'blur\' }"> </li> <li class="sliderContainer">Hora del día <rzslider class="custom-slider" rz-slider-model="slider.minValue" rz-slider-high="slider.maxValue" rz-slider-options="slider.options"></rzslider> </li> </ul> <button class="collapse" type="button" ng-click="mostrar(2)" ng-if="credentials.currentUser.role == \'ADMI\' || credentials.currentUser.role == \'SUPE\'">Ranking vendedores según visitas para supervisor seleccionado</button> <ul class="collapsible" ng-if="collapseb" id="Collapsible2Ges"> <div class="vendorsWrap"> <label ng-repeat="vendedor in vendedoresConRank"><span class="rank"># {{vendedor.ranking}}</span><span> {{vendedor.nombre }}</span></label> <label ng-repeat="vendedor in vendedoresSinRank"><span> {{vendedor.nombre }}</span></label> </div> </ul> </div> <button class="greenBar" type="button" ng-disabled="saving" ng-click="getMarcadores(ctrl.dia, slider.minValue, slider.maxValue)">Actualizar Resultados<img ng-hide="hideLoader" src="images/loader.7f9353b0.gif" width="20" height="20"></button> <div class="info"> <p>Información sobre el rendimiento de ventas <div class="red"></div>0-25% <div class="orange"></div>25-50% <div class="yellow"></div>50-75% <div class="green"></div>75-100% </p> </div> <div id="mapa"> <gm-map gm-then="bindMap(map)" options="{center: [-33.455,-70.655], zoom: 9, mapTypeId: google.maps.MapTypeId.TERRAIN}"> <gm-marker ng-repeat="marcador in marcadores" on-click="showInfoWindow(map,marker,marcador)" options="{position: marcador.position, icon:marcador.icon}"> </gm-marker> </gm-map> </div> </div>'),a.put("views/main.html",'<div class="center-alignment" ng-controller="loginController"> <form name="loginForm" novalidate> <div class="login"> <div class="logocontainer"><img src="images/logo-caserita.ca8302fa.jpg" alt="logo"></div> <input type="text" name="username" id="username" ng-model="username" placeholder="Usuario" required><br> <input type="text" name="password" id="password" ng-model="password" placeholder="Contraseña" required><br> <button type="submit" ng-click="login()">ENTRAR <div class="elgranproblema"><img class="loader" ng-hide="hideLoginLoader" src="images/loader.7f9353b0.gif" width="20" height="20"></div> </button> </div><br> <div class="errorMsgs"> <p class="error" ng-if="loginForm.$submitted &amp;&amp; serError == true"><strong>Error al conectar</strong> al servicio de login.</p> <div ng-if="serError == false"> <p class="error" ng-if="loginForm.$submitted &amp;&amp; loginForm.$error.user">El <strong>nombre de usuario</strong> o la <strong>contraseña</strong> son incorrectos.</p> <p class="error" ng-if="loginForm.$submitted &amp;&amp; username == null">Debe indicar <strong>usuario</strong>.</p> <p class="error" ng-if="loginForm.$submitted &amp;&amp; password == null">Debe indicar <strong>contraseña</strong>.</p> </div> </div> </form> <p class="copyright">2017 © La Caserita</p> </div>')}]);